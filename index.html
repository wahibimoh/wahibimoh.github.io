<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPFS Web Worker Test</title>
</head>
<body>
    <h1>OPFS Web Worker Test v3</h1>
    <div id="useragent"></div>
    <div id="output"></div>

    <script>

const outputDiv = document.getElementById('output');

document.addEventListener('DOMContentLoaded', async () => {
    useragent.textContent = navigator.userAgent +""
    outputDiv.textContent = await testWorker()
});

function testWorker(){
    const workerCode = `
        self.onmessage = async (event) => {
            if (event.data === 'start_opfs_test') {
                try {
                    const opfsRoot = await navigator.storage.getDirectory();
                    const fileName = 'test_file.txt';

                    // Create a file handle we can reuse for both writing and reading
                    const fileHandle = await opfsRoot.getFileHandle(fileName, { create: true });
                    const data = 'Hello from OPFS in Web Worker!';
                    const encoder = new TextEncoder();
                    const encoded = encoder.encode(data);

                    let wroteFile = false;
                    let writeMethod = null;
                    let lastWriteError = null;

                    // Prefer the sync access handle path (Safari 16 supports this even without createWritable)
                    if (typeof fileHandle.createSyncAccessHandle === 'function') {
                        try {
                            const accessHandle = await fileHandle.createSyncAccessHandle();
                            try {
                                accessHandle.truncate(0);
                                accessHandle.write(encoded, { at: 0 });
                                accessHandle.flush();
                                wroteFile = true;
                                writeMethod = 'sync';
                            } finally {
                                accessHandle.close();
                            }
                        } catch (err) {
                            lastWriteError = err;
                        }
                    }

                    // Fallback to FileSystemWritableFileStream when available
                    if (!wroteFile && typeof fileHandle.createWritable === 'function') {
                        const writable = await fileHandle.createWritable();
                        await writable.write(data);
                        await writable.close();
                        wroteFile = true;
                        writeMethod = 'writable';
                    }

                    if (!wroteFile) {
                        throw lastWriteError || new Error('No supported OPFS write method available');
                    }

                    // Read from the file using getFile(). Safari 16.0 has a bug where
                    // getFile() after a sync write sometimes reports size 0, so fall
                    // back to another sync read if that happens.
                    const file = await fileHandle.getFile();
                    let content = await file.text();
                    if (!content && writeMethod === 'sync' && file.size === 0 && typeof fileHandle.createSyncAccessHandle === 'function') {
                        const accessHandle = await fileHandle.createSyncAccessHandle();
                        try {
                            const readBuffer = new ArrayBuffer(encoded.byteLength);
                            accessHandle.read(readBuffer, { at: 0 });
                            const decoder = new TextDecoder();
                            content = decoder.decode(readBuffer);
                        } finally {
                            accessHandle.close();
                        }
                    }

                    self.postMessage("Content: "+content);

                } catch (error) {
                    self.postMessage("Error: "+error.message);
                }
            }
        };
    `;

    const workerBlob = new Blob([workerCode], { type: 'text/javascript' });
    const workerBlobURL = URL.createObjectURL(workerBlob);
    const worker = new Worker(workerBlobURL);
    worker.postMessage('start_opfs_test');
    return new Promise((res,rej)=>{
        worker.onmessage = (event) => {
        //outputDiv.textContent = event.data;
        worker.terminate(); // Terminate worker after test
        res(event.data);
        };

        worker.onerror = (error) => {
            //outputDiv.textContent = `Worker error: ${error.message}`;
            worker.terminate();
            rej(error.message)
        };
    })
}
    </script>
</body>
</html>
