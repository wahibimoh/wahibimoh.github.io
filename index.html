<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPFS Web Worker Test v2</title>
</head>
<body>
    <h1>OPFS Web Worker Test</h1>
    <div id="useragent"></div>
    <div id="output"></div>

    <script>

const outputDiv = document.getElementById('output');

document.addEventListener('DOMContentLoaded', async () => {
    useragent.textContent = navigator.userAgent +""
    outputDiv.textContent = await testWorker()
});

function testWorker(){
    const workerCode = `
        self.onmessage = async (event) => {
            if (event.data === 'start_opfs_test') {
                try {
                    const opfsRoot = await navigator.storage.getDirectory();
                    const fileName = 'test_file.txt';

                    // Create and write to a file using the async File System API
                    const fileHandle = await opfsRoot.getFileHandle(fileName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write('Hello from OPFS in Web Worker!');
                    await writable.close();

                    // Read from the file using getFile()
                    const readFileHandle = await opfsRoot.getFileHandle(fileName);
                    const file = await readFileHandle.getFile();
                    const content = await file.text();

                    self.postMessage("Content: "+content);

                } catch (error) {
                    self.postMessage("Error: "+error.message);
                }
            }
        };
    `;

    const workerBlob = new Blob([workerCode], { type: 'text/javascript' });
    const workerBlobURL = URL.createObjectURL(workerBlob);
    const worker = new Worker(workerBlobURL);
    worker.postMessage('start_opfs_test');
    return new Promise((res,rej)=>{
        worker.onmessage = (event) => {
        //outputDiv.textContent = event.data;
        worker.terminate(); // Terminate worker after test
        res(event.data);
        };

        worker.onerror = (error) => {
            //outputDiv.textContent = `Worker error: ${error.message}`;
            worker.terminate();
            rej(error.message)
        };
    })
}
    </script>
</body>
</html>
